# OpsConductor Database Schema Management

## Overview

This directory contains all database schema files for OpsConductor. The database uses PostgreSQL with multiple schemas for different services.

## Required Schemas

OpsConductor requires the following PostgreSQL schemas:

1. **`identity`** - User management, roles, and permissions
2. **`assets`** - Asset/target management
3. **`automation`** - Job scheduling and execution tracking
4. **`communication`** - Notification templates and messaging
5. **`tool_catalog`** - AI pipeline tool definitions (replaces YAML files)
6. **`execution`** - Stage E execution tracking (Phase 7)
7. **`network_analysis`** - Network topology and analysis (optional)

## Master Schema File

**`master-schema.sql`** - The COMPLETE schema file that includes ALL required tables.

This file is automatically generated by concatenating:
- `complete-schema.sql` (base schemas: identity, assets, automation, communication)
- `tool-catalog-schema.sql` (tool catalog for AI pipeline)
- `phase7-execution-schema.sql` (execution tracking)

### Regenerating master-schema.sql

If you update any of the component schema files, regenerate the master schema:

```bash
cat complete-schema.sql tool-catalog-schema.sql phase7-execution-schema.sql > master-schema.sql
```

## Database Initialization

### Automated Initialization

Use the `init-db.sh` script to automatically initialize or verify the database:

```bash
./database/init-db.sh
```

This script will:
1. ✅ Check if PostgreSQL is ready
2. ✅ Detect if database is empty and initialize with `master-schema.sql`
3. ✅ Check for missing schemas and add them if needed
4. ✅ Verify all critical tables exist
5. ✅ Display database summary with counts

### Manual Initialization

If you need to manually initialize the database:

```bash
# Initialize complete database from scratch
docker exec -i opsconductor-postgres psql -U opsconductor -d opsconductor < database/master-schema.sql

# Or initialize individual schemas
docker exec -i opsconductor-postgres psql -U opsconductor -d opsconductor < database/complete-schema.sql
docker exec -i opsconductor-postgres psql -U opsconductor -d opsconductor < database/tool-catalog-schema.sql
docker exec -i opsconductor-postgres psql -U opsconductor -d opsconductor < database/phase7-execution-schema.sql
```

## Critical Tables Verified by init-db.sh

The initialization script verifies these critical tables exist:

### Identity Schema
- `identity.users` - User accounts
- `identity.roles` - Role definitions
- `identity.user_roles` - User-role mappings

### Assets Schema
- `assets.assets` - Consolidated asset/target information

### Automation Schema
- `automation.jobs` - Scheduled jobs
- `automation.job_executions` - Job execution history

### Communication Schema
- `communication.notification_templates` - Notification templates

### Tool Catalog Schema
- `tool_catalog.tools` - Tool definitions for AI pipeline
- `tool_catalog.tool_capabilities` - Tool capabilities
- `tool_catalog.tool_patterns` - Usage patterns for tool matching

### Execution Schema (Phase 7)
- `execution.executions` - Execution records
- `execution.execution_steps` - Step-level tracking
- `execution.execution_queue` - Background execution queue

## Schema Files Reference

### Active Schema Files

| File | Purpose | Status |
|------|---------|--------|
| `master-schema.sql` | **COMPLETE** schema with ALL tables | ✅ **USE THIS** |
| `complete-schema.sql` | Base schemas (identity, assets, automation, communication) | ✅ Active |
| `tool-catalog-schema.sql` | Tool catalog for AI pipeline (replaces YAML) | ✅ Active |
| `phase7-execution-schema.sql` | Stage E execution tracking | ✅ Active |
| `init-db.sh` | Automated database initialization script | ✅ Active |

### Legacy/Migration Files

| File | Purpose | Status |
|------|---------|--------|
| `complete-schema-with-user-management.sql` | Old schema with local user management | ⚠️ Legacy (use Keycloak) |
| `init-schema.sql` | Old initialization script | ⚠️ Legacy |
| `consolidate-assets-schema.sql` | Migration script for asset consolidation | ⚠️ Migration only |
| `migrate-network-analysis.sql` | Network analysis migration | ⚠️ Migration only |
| `network-analysis-schema.sql` | Network analysis tables | ⚠️ Optional feature |
| `fix_asset_tool_capabilities.sql` | One-time fix script | ⚠️ Historical |

## Important Notes

### ⚠️ The "complete" schema is NOT complete!

The file `complete-schema.sql` is **NOT** actually complete - it's missing:
- ❌ `tool_catalog` schema
- ❌ `execution` schema

**Always use `master-schema.sql` for fresh installations!**

### Database-First Architecture

OpsConductor uses a **database-first** approach:

1. **Tool Catalog**: Tools are stored in PostgreSQL (`tool_catalog` schema), NOT in YAML files
2. **No YAML Fallback**: The AI pipeline ONLY reads from the database
3. **Execution Tracking**: All executions are tracked in the `execution` schema

### Migration from YAML to Database

If you have old YAML tool definitions in `/pipeline/config/tools/`, they are **IGNORED**. The system only uses the database.

To migrate YAML tools to database, use the migration script (if available) or manually insert into `tool_catalog.tools`.

## Troubleshooting

### Missing Tables Error

If you see errors about missing tables:

```bash
# Run the init script to check what's missing
./database/init-db.sh

# If tables are missing, reinitialize with master schema
docker exec -i opsconductor-postgres psql -U opsconductor -d opsconductor < database/master-schema.sql
```

### Execution Schema Missing

If you see `relation "execution.executions" does not exist`:

```bash
# Add the execution schema
docker exec -i opsconductor-postgres psql -U opsconductor -d opsconductor < database/phase7-execution-schema.sql
```

### Tool Catalog Schema Missing

If the AI pipeline can't find tools:

```bash
# Add the tool catalog schema
docker exec -i opsconductor-postgres psql -U opsconductor -d opsconductor < database/tool-catalog-schema.sql
```

## Database Connection Info

- **Host**: `opsconductor-postgres` (Docker container name)
- **Port**: `5432`
- **Database**: `opsconductor`
- **User**: `opsconductor`
- **Password**: Set in environment variables

## Verification Commands

```bash
# List all schemas
docker exec opsconductor-postgres psql -U opsconductor -d opsconductor -c "\dn"

# List all tables
docker exec opsconductor-postgres psql -U opsconductor -d opsconductor -c "\dt *.*"

# Count tables per schema
docker exec opsconductor-postgres psql -U opsconductor -d opsconductor -c "
SELECT table_schema, COUNT(*) as table_count 
FROM information_schema.tables 
WHERE table_schema NOT IN ('information_schema', 'pg_catalog') 
GROUP BY table_schema 
ORDER BY table_schema;"

# Check tool catalog
docker exec opsconductor-postgres psql -U opsconductor -d opsconductor -c "
SELECT COUNT(*) as tool_count FROM tool_catalog.tools;"

# Check executions
docker exec opsconductor-postgres psql -U opsconductor -d opsconductor -c "
SELECT COUNT(*) as execution_count FROM execution.executions;"
```

## Development Workflow

When adding new features that require database changes:

1. **Update the appropriate schema file** (`complete-schema.sql`, `tool-catalog-schema.sql`, or `phase7-execution-schema.sql`)
2. **Regenerate master-schema.sql**:
   ```bash
   cat complete-schema.sql tool-catalog-schema.sql phase7-execution-schema.sql > master-schema.sql
   ```
3. **Update init-db.sh** if adding new critical tables
4. **Test with init-db.sh** to ensure verification works
5. **Document changes** in this README

## Schema Version History

- **v1.0** - Initial schema with identity, assets, automation, communication
- **v2.0** - Added tool_catalog schema (database-first tool management)
- **v3.0** - Added execution schema (Phase 7 execution tracking)
- **v3.1** - Created master-schema.sql and updated init-db.sh for complete verification