_format_version: "3.0"
_transform: true

services:
  # Keycloak Authentication Service
  # NOTE: Keycloak container listens on 8080 internally
  - name: keycloak-auth
    url: http://keycloak:8080
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - Authorization
          exposed_headers:
            - Authorization
          credentials: true
          max_age: 3600

  # Asset Service
  - name: asset-service
    url: http://asset-service:8002
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - Authorization
          exposed_headers:
            - Authorization
          credentials: true
          max_age: 3600

  # Automation Service
  - name: automation-service
    url: http://automation-service:8005
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - Authorization
          exposed_headers:
            - Authorization
          credentials: true
          max_age: 3600

  # AI Pipeline Service
  - name: ai-pipeline-service
    url: http://ai-pipeline:8006
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - Authorization
          exposed_headers:
            - Authorization
          credentials: true
          max_age: 3600

routes:
  # Keycloak Auth Routes (highest priority)
  - name: keycloak-auth-routes
    service: keycloak-auth
    paths:
      - /api/v1/auth/
      - /api/v1/auth
    strip_path: true
    preserve_host: false
    regex_priority: 300
    methods:
      - GET
      - POST
      - OPTIONS

  # Asset Service Routes
  - name: asset-routes
    service: asset-service
    paths:
      - /api/v1/assets/
      - /api/v1/assets
    strip_path: true
    preserve_host: false
    regex_priority: 200
    methods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS

  # Automation Service Routes (jobs, runs, credentials, etc.)
  - name: automation-jobs-routes
    service: automation-service
    paths:
      - /api/v1/jobs/
      - /api/v1/jobs
      - /api/v1/runs/
      - /api/v1/runs
      - /api/v1/credentials/
      - /api/v1/credentials
    strip_path: true
    preserve_host: false
    regex_priority: 200
    methods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS

  # Automation Service Routes
  - name: automation-routes
    service: automation-service
    paths:
      - /api/automation/
      - /api/automation
    strip_path: true
    preserve_host: false
    methods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS

  # AI Pipeline Routes
  - name: ai-pipeline-routes
    service: ai-pipeline-service
    paths:
      - /api/ai/
      - /api/ai
    strip_path: true
    preserve_host: false
    methods:
      - GET
      - POST
      - OPTIONS