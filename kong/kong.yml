_format_version: "3.0"
_transform: true

services:
  # Keycloak Authentication Service
  - name: keycloak-auth
    url: http://keycloak:8080
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - Authorization
          exposed_headers:
            - Authorization
          credentials: true
          max_age: 3600

  # Asset Service
  - name: asset-service
    url: http://asset-service:3002
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - Authorization
          exposed_headers:
            - Authorization
          credentials: true
          max_age: 3600

  # Automation Service
  - name: automation-service
    url: http://automation-service:3003
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - Authorization
          exposed_headers:
            - Authorization
          credentials: true
          max_age: 3600

  # Communication Service
  - name: communication-service
    url: http://communication-service:3004
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - Authorization
          exposed_headers:
            - Authorization
          credentials: true
          max_age: 3600

  # AI Pipeline Service
  - name: ai-pipeline-service
    url: http://ai-pipeline:8000
    # Increased timeouts for full LLM pipeline processing (no fast paths)
    connect_timeout: 120000  # 120 seconds
    write_timeout: 120000    # 120 seconds
    read_timeout: 120000     # 120 seconds
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - Authorization
          exposed_headers:
            - Authorization
          credentials: true
          max_age: 3600

routes:
  # Keycloak Auth Routes (highest priority)
  - name: keycloak-auth-routes
    service: keycloak-auth
    paths:
      - /api/v1/auth
    strip_path: true
    preserve_host: false
    regex_priority: 300
    methods:
      - GET
      - POST
      - OPTIONS

  # Asset Service Routes
  - name: asset-routes
    service: asset-service
    paths:
      - /api/v1/assets
    strip_path: true
    preserve_host: false
    regex_priority: 200
    methods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS

  # Automation Service Routes (jobs, runs, credentials, etc.)
  - name: automation-jobs-routes
    service: automation-service
    paths:
      - /api/v1/jobs
      - /api/v1/runs
      - /api/v1/credentials
    strip_path: true
    preserve_host: false
    regex_priority: 200
    methods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS

  # Automation Service Routes
  - name: automation-routes
    service: automation-service
    paths:
      - /api/automation
    strip_path: true
    preserve_host: false
    methods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS

  # AI Execution Proxy Route (PR #4 - Walking Skeleton)
  - name: ai-execute-routes
    service: automation-service
    paths:
      - /ai/execute
    strip_path: false
    preserve_host: false
    regex_priority: 300
    methods:
      - POST
      - OPTIONS

  # AI Tools Proxy Routes (PR #8 - Tools Registry & Fallback)
  - name: ai-tools-routes
    service: automation-service
    paths:
      - /ai/tools
    strip_path: false
    preserve_host: false
    regex_priority: 300
    methods:
      - GET
      - POST
      - OPTIONS

  # Communication Service Routes - Notifications
  - name: communication-notifications-routes
    service: communication-service
    paths:
      - ~/api/v1/notifications(/.*)?$
    strip_path: false
    preserve_host: false
    regex_priority: 250
    methods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: "/notifications$(uri_captures[1])"

  # Communication Service Routes - Channels
  - name: communication-channels-routes
    service: communication-service
    paths:
      - ~/api/v1/channels(/.*)?$
    strip_path: false
    preserve_host: false
    regex_priority: 250
    methods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: "/channels$(uri_captures[1])"

  # Communication Service Routes - Templates
  - name: communication-templates-routes
    service: communication-service
    paths:
      - ~/api/v1/templates(/.*)?$
    strip_path: false
    preserve_host: false
    regex_priority: 250
    methods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS
    plugins:
      - name: request-transformer
        config:
          replace:
            uri: "/templates$(uri_captures[1])"

  # AI Pipeline Routes
  - name: ai-pipeline-routes
    service: ai-pipeline-service
    paths:
      - /api/ai
    strip_path: true
    preserve_host: false
    methods:
      - GET
      - POST
      - OPTIONS