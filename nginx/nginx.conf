events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    # Logging
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log;
    
    # Basic settings
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 100M;
    
    # Handle large headers (for JWT tokens)
    large_client_header_buffers 4 32k;
    client_header_buffer_size 8k;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;

    # Upstream definitions
    upstream auth-service { server opsconductor-auth:3001; }
    upstream user-service { server opsconductor-users:3002; }
    upstream credentials-service { server opsconductor-credentials:3004; }
    upstream targets-service { server opsconductor-targets:3005; }
    upstream jobs-service { server opsconductor-jobs:3006; }
    upstream executor-service { server opsconductor-executor:3007; }
    upstream scheduler-service { server opsconductor-scheduler:3008; }
    upstream notification-service { server opsconductor-notification:3009; }
    upstream discovery-service { server opsconductor-discovery:3010; }
    upstream frontend { server opsconductor-frontend:3000; }

    # HTTP server (serve application directly)
    server {
        listen 80;
        server_name _;

        # Health checks (unauthenticated)
        location /api/v1/auth/health {
            proxy_pass http://auth-service/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /api/v1/users/health {
            proxy_pass http://user-service/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /api/v1/credentials/health {
            proxy_pass http://credentials-service/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /api/v1/targets/health {
            proxy_pass http://targets-service/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /api/v1/jobs/health {
            proxy_pass http://jobs-service/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /api/v1/executor/health {
            proxy_pass http://executor-service/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /api/v1/scheduler/health {
            proxy_pass http://scheduler-service/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /api/v1/notification/health {
            proxy_pass http://notification-service/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /api/v1/discovery/health {
            proxy_pass http://discovery-service/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Auth Service - Verify endpoint
        location /api/v1/verify {
            rewrite ^/api/v1/(.*)$ /$1 break;
            proxy_pass http://auth-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Auth Service
        location /api/v1/auth {
            rewrite ^/api/v1/auth/(.*)$ /$1 break;
            rewrite ^/api/v1/auth$ / break;
            proxy_pass http://auth-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # User Service
        location /api/v1/users {
            rewrite ^/api/v1/users/(.*)$ /users/$1 break;
            rewrite ^/api/v1/users$ /users break;
            proxy_pass http://user-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Credentials Service
        location /api/v1/credentials {
            rewrite ^/api/v1/credentials/(.*)$ /credentials/$1 break;
            rewrite ^/api/v1/credentials$ /credentials break;
            proxy_pass http://credentials-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Enhanced Targets Service - Service Definitions
        location /api/v1/targets/service-definitions {
            rewrite ^/api/v1/targets/(.*)$ /$1 break;
            proxy_pass http://targets-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Targets Service
        location /api/v1/targets {
            rewrite ^/api/v1/targets/(.*)$ /targets/$1 break;
            rewrite ^/api/v1/targets$ /targets break;
            proxy_pass http://targets-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Job Runs (specific route before jobs)
        location /api/v1/runs {
            rewrite ^/api/v1/runs/(.*)$ /runs/$1 break;
            rewrite ^/api/v1/runs$ /runs break;
            proxy_pass http://jobs-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Jobs Service
        location /api/v1/jobs {
            rewrite ^/api/v1/jobs/(.*)$ /jobs/$1 break;
            rewrite ^/api/v1/jobs$ /jobs break;
            proxy_pass http://jobs-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Executor Service
        location /api/v1/executor {
            rewrite ^/api/v1/executor/(.*)$ /$1 break;
            rewrite ^/api/v1/executor$ / break;
            proxy_pass http://executor-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Scheduler Service
        location /api/v1/scheduler {
            rewrite ^/api/v1/scheduler/(.*)$ /$1 break;
            rewrite ^/api/v1/scheduler$ / break;
            proxy_pass http://scheduler-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Schedules (handled by scheduler service)
        location /api/v1/schedules {
            rewrite ^/api/v1/schedules/(.*)$ /schedules/$1 break;
            rewrite ^/api/v1/schedules$ /schedules break;
            proxy_pass http://scheduler-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Notification Service
        location /api/v1/notification {
            rewrite ^/api/v1/notification/(.*)$ /$1 break;
            rewrite ^/api/v1/notification$ / break;
            proxy_pass http://notification-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Discovery Service
        location /api/v1/discovery {
            rewrite ^/api/v1/discovery/(.*)$ /$1 break;
            rewrite ^/api/v1/discovery$ / break;
            proxy_pass http://discovery-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Frontend - serve React app
        location / {
            proxy_pass http://frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_redirect off;
        }
    }

    # HTTPS server
    server {
        listen 443 ssl;
        http2 on;
        server_name _;

        # SSL configuration
        ssl_certificate /etc/nginx/ssl/nginx.crt;
        ssl_certificate_key /etc/nginx/ssl/nginx.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384;
        ssl_prefer_server_ciphers off;

        # Health checks (unauthenticated)
        location /api/v1/auth/health {
            proxy_pass http://auth-service/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /api/v1/users/health {
            proxy_pass http://user-service/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /api/v1/credentials/health {
            proxy_pass http://credentials-service/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /api/v1/targets/health {
            proxy_pass http://targets-service/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /api/v1/jobs/health {
            proxy_pass http://jobs-service/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /api/v1/executor/health {
            proxy_pass http://executor-service/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /api/v1/scheduler/health {
            proxy_pass http://scheduler-service/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /api/v1/notification/health {
            proxy_pass http://notification-service/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /api/v1/discovery/health {
            proxy_pass http://discovery-service/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Auth Service - Verify endpoint
        location /api/v1/verify {
            rewrite ^/api/v1/(.*)$ /$1 break;
            proxy_pass http://auth-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Auth Service
        location /api/v1/auth {
            rewrite ^/api/v1/auth/(.*)$ /$1 break;
            rewrite ^/api/v1/auth$ / break;
            proxy_pass http://auth-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # User Service
        location /api/v1/users {
            rewrite ^/api/v1/users/(.*)$ /users/$1 break;
            rewrite ^/api/v1/users$ /users break;
            proxy_pass http://user-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Credentials Service
        location /api/v1/credentials {
            rewrite ^/api/v1/credentials/(.*)$ /credentials/$1 break;
            rewrite ^/api/v1/credentials$ /credentials break;
            proxy_pass http://credentials-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Enhanced Targets Service - Service Definitions
        location /api/v1/targets/service-definitions {
            rewrite ^/api/v1/targets/(.*)$ /$1 break;
            proxy_pass http://targets-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Targets Service
        location /api/v1/targets {
            rewrite ^/api/v1/targets/(.*)$ /targets/$1 break;
            rewrite ^/api/v1/targets$ /targets break;
            proxy_pass http://targets-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Job Runs (specific route before jobs)
        location /api/v1/runs {
            rewrite ^/api/v1/runs/(.*)$ /runs/$1 break;
            rewrite ^/api/v1/runs$ /runs break;
            proxy_pass http://jobs-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Jobs Service
        location /api/v1/jobs {
            rewrite ^/api/v1/jobs/(.*)$ /jobs/$1 break;
            rewrite ^/api/v1/jobs$ /jobs break;
            proxy_pass http://jobs-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Executor Service
        location /api/v1/executor {
            rewrite ^/api/v1/executor/(.*)$ /$1 break;
            rewrite ^/api/v1/executor$ / break;
            proxy_pass http://executor-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Scheduler Service
        location /api/v1/scheduler {
            rewrite ^/api/v1/scheduler/(.*)$ /$1 break;
            rewrite ^/api/v1/scheduler$ / break;
            proxy_pass http://scheduler-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Schedules (handled by scheduler service)
        location /api/v1/schedules {
            rewrite ^/api/v1/schedules/(.*)$ /schedules/$1 break;
            rewrite ^/api/v1/schedules$ /schedules break;
            proxy_pass http://scheduler-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Notification Service
        location /api/v1/notification {
            rewrite ^/api/v1/notification/(.*)$ /$1 break;
            rewrite ^/api/v1/notification$ / break;
            proxy_pass http://notification-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Discovery Service
        location /api/v1/discovery {
            rewrite ^/api/v1/discovery/(.*)$ /$1 break;
            rewrite ^/api/v1/discovery$ / break;
            proxy_pass http://discovery-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Frontend - serve React app (FIXED)
        location / {
            proxy_pass http://frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_redirect off;
        }
    }
}