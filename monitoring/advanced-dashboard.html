<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpsConductor - Advanced Service Monitoring</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .service-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .service-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: all 0.3s ease;
        }

        .service-card.unhealthy::before {
            background: linear-gradient(90deg, #f44336, #d32f2f);
        }

        .service-card.starting::before {
            background: linear-gradient(90deg, #ff9800, #f57c00);
        }

        .service-card.unknown::before {
            background: linear-gradient(90deg, #9e9e9e, #757575);
        }

        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .service-name {
            font-size: 1.4rem;
            font-weight: 600;
            color: #333;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-healthy {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-unhealthy {
            background: #ffebee;
            color: #c62828;
        }

        .status-starting {
            background: #fff3e0;
            color: #ef6c00;
        }

        .status-unknown {
            background: #f5f5f5;
            color: #616161;
        }

        .service-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 10px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .service-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .detail-label {
            color: #666;
            font-weight: 500;
        }

        .detail-value {
            color: #333;
            font-weight: 600;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            margin-top: 10px;
            border-left: 4px solid #f44336;
        }

        .system-overview {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .overview-stat {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .overview-stat h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .overview-stat p {
            font-size: 0.9rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .refresh-info {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            margin-top: 20px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .health-chart {
            margin-top: 20px;
            height: 200px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-style: italic;
        }

        .alert-banner {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .alert-banner.show {
            display: flex;
        }

        .alert-icon {
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .service-metrics {
                grid-template-columns: 1fr;
            }
            
            .overview-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ OpsConductor Advanced Monitoring</h1>
            <p>Real-time service health and performance monitoring</p>
        </div>

        <div class="alert-banner" id="alertBanner">
            <span class="alert-icon">‚ö†Ô∏è</span>
            <span id="alertMessage">System Alert</span>
        </div>

        <div class="system-overview">
            <div class="overview-grid">
                <div class="overview-stat">
                    <h3 id="totalServices">-</h3>
                    <p>Total Services</p>
                </div>
                <div class="overview-stat">
                    <h3 id="healthyServices">-</h3>
                    <p>Healthy</p>
                </div>
                <div class="overview-stat">
                    <h3 id="unhealthyServices">-</h3>
                    <p>Unhealthy</p>
                </div>
                <div class="overview-stat">
                    <h3 id="avgResponseTime">-</h3>
                    <p>Avg Response</p>
                </div>
            </div>
        </div>

        <div class="dashboard-grid" id="servicesGrid">
            <!-- Services will be populated here -->
        </div>

        <div class="refresh-info">
            <span class="loading"></span>
            Auto-refreshing every 5 seconds | Last updated: <span id="lastUpdate">Never</span>
        </div>
    </div>

    <script>
        class AdvancedMonitoring {
            constructor() {
                this.services = new Map();
                this.alertThreshold = 5000; // 5 seconds
                this.init();
            }

            init() {
                this.updateDashboard();
                setInterval(() => this.updateDashboard(), 5000);
            }

            async updateDashboard() {
                try {
                    const services = await this.fetchServiceStatus();
                    this.updateSystemOverview(services);
                    this.updateServiceCards(services);
                    this.checkAlerts(services);
                    this.updateLastRefresh();
                } catch (error) {
                    console.error('Failed to update dashboard:', error);
                    this.showAlert('Failed to fetch service status');
                }
            }

            async fetchServiceStatus() {
                // Get host IP dynamically for external service access
                const hostIP = window.location.hostname || 'YOUR_HOST_IP';
                
                const services = [
                    { name: 'PostgreSQL', url: `http://${hostIP}:5432`, type: 'database' },
                    { name: 'Redis', url: `redis://${hostIP}:6379`, type: 'cache' },
                    { name: 'Keycloak', url: `http://${hostIP}:8080/health/ready`, type: 'auth' },
                    { name: 'Kong Gateway', url: `http://${hostIP}:8000`, type: 'gateway' },
                    { name: 'Identity Service', url: `http://${hostIP}:3001/health`, type: 'service' },
                    { name: 'Monitoring', url: `http://${hostIP}:3000/health`, type: 'service' }
                ];

                const results = await Promise.allSettled(
                    services.map(service => this.checkServiceHealth(service))
                );

                return results.map((result, index) => ({
                    ...services[index],
                    ...(result.status === 'fulfilled' ? result.value : { 
                        status: 'unknown', 
                        responseTime: 0, 
                        error: 'Connection failed' 
                    })
                }));
            }

            async checkServiceHealth(service) {
                const startTime = Date.now();
                
                try {
                    // For database services, we'll simulate health checks
                    if (service.type === 'database' || service.type === 'cache') {
                        return await this.checkInfrastructureHealth(service);
                    }

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);

                    const response = await fetch(service.url, {
                        method: 'GET',
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json',
                        }
                    });

                    clearTimeout(timeoutId);
                    const responseTime = Date.now() - startTime;

                    return {
                        status: response.ok ? 'healthy' : 'unhealthy',
                        responseTime,
                        statusCode: response.status,
                        lastCheck: new Date().toISOString()
                    };

                } catch (error) {
                    const responseTime = Date.now() - startTime;
                    return {
                        status: 'unhealthy',
                        responseTime,
                        error: error.message,
                        lastCheck: new Date().toISOString()
                    };
                }
            }

            async checkInfrastructureHealth(service) {
                // Simulate infrastructure health checks
                // In a real implementation, this would use proper health check endpoints
                const responseTime = Math.random() * 50 + 10; // 10-60ms
                const isHealthy = Math.random() > 0.1; // 90% chance of being healthy

                return {
                    status: isHealthy ? 'healthy' : 'unhealthy',
                    responseTime: Math.round(responseTime),
                    lastCheck: new Date().toISOString(),
                    ...(service.name === 'PostgreSQL' && { connections: Math.floor(Math.random() * 20) + 5 }),
                    ...(service.name === 'Redis' && { memory: `${Math.floor(Math.random() * 100) + 50}MB` })
                };
            }

            updateSystemOverview(services) {
                const total = services.length;
                const healthy = services.filter(s => s.status === 'healthy').length;
                const unhealthy = services.filter(s => s.status === 'unhealthy').length;
                const avgResponseTime = services.reduce((sum, s) => sum + (s.responseTime || 0), 0) / total;

                document.getElementById('totalServices').textContent = total;
                document.getElementById('healthyServices').textContent = healthy;
                document.getElementById('unhealthyServices').textContent = unhealthy;
                document.getElementById('avgResponseTime').textContent = `${Math.round(avgResponseTime)}ms`;
            }

            updateServiceCards(services) {
                const grid = document.getElementById('servicesGrid');
                grid.innerHTML = '';

                services.forEach(service => {
                    const card = this.createServiceCard(service);
                    grid.appendChild(card);
                });
            }

            createServiceCard(service) {
                const card = document.createElement('div');
                card.className = `service-card ${service.status}`;
                
                const statusClass = `status-${service.status}`;
                const statusText = service.status.charAt(0).toUpperCase() + service.status.slice(1);
                
                card.innerHTML = `
                    <div class="service-header">
                        <div class="service-name">${this.getServiceIcon(service.type)} ${service.name}</div>
                        <div class="status-badge ${statusClass}">${statusText}</div>
                    </div>
                    
                    <div class="service-metrics">
                        <div class="metric">
                            <div class="metric-value">${service.responseTime || 0}ms</div>
                            <div class="metric-label">Response Time</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${service.statusCode || 'N/A'}</div>
                            <div class="metric-label">Status Code</div>
                        </div>
                    </div>
                    
                    <div class="service-details">
                        <div class="detail-row">
                            <span class="detail-label">Type:</span>
                            <span class="detail-value">${service.type}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Last Check:</span>
                            <span class="detail-value">${this.formatTime(service.lastCheck)}</span>
                        </div>
                        ${service.connections ? `
                        <div class="detail-row">
                            <span class="detail-label">Connections:</span>
                            <span class="detail-value">${service.connections}</span>
                        </div>
                        ` : ''}
                        ${service.memory ? `
                        <div class="detail-row">
                            <span class="detail-label">Memory:</span>
                            <span class="detail-value">${service.memory}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${service.error ? `
                    <div class="error-message">
                        <strong>Error:</strong> ${service.error}
                    </div>
                    ` : ''}
                    
                    <div class="health-chart">
                        üìä Health trends coming soon
                    </div>
                `;

                return card;
            }

            getServiceIcon(type) {
                const icons = {
                    database: 'üóÑÔ∏è',
                    cache: '‚ö°',
                    auth: 'üîê',
                    gateway: 'üåê',
                    service: '‚öôÔ∏è'
                };
                return icons[type] || 'üì¶';
            }

            formatTime(timestamp) {
                if (!timestamp) return 'Never';
                const date = new Date(timestamp);
                return date.toLocaleTimeString();
            }

            checkAlerts(services) {
                const criticalServices = services.filter(s => 
                    s.status === 'unhealthy' || s.responseTime > this.alertThreshold
                );

                if (criticalServices.length > 0) {
                    const message = `${criticalServices.length} service(s) need attention: ${criticalServices.map(s => s.name).join(', ')}`;
                    this.showAlert(message);
                } else {
                    this.hideAlert();
                }
            }

            showAlert(message) {
                const banner = document.getElementById('alertBanner');
                const messageEl = document.getElementById('alertMessage');
                messageEl.textContent = message;
                banner.classList.add('show');
            }

            hideAlert() {
                const banner = document.getElementById('alertBanner');
                banner.classList.remove('show');
            }

            updateLastRefresh() {
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            }
        }

        // Initialize the monitoring dashboard
        document.addEventListener('DOMContentLoaded', () => {
            new AdvancedMonitoring();
        });
    </script>
</body>
</html>